<?xml version="1.0" encoding="utf-8"?>
<odoo>
	<data>
		<!-- Inherit the standard delivery slip to inject the template -->
		<template id="report_deliveryslip_inherit_report_suite_galaxus"
              inherit_id="stock.report_deliveryslip">
			<xpath expr="//t[@t-call='stock.report_delivery_document']" position="replace">
				<t t-if="env['ir.config_parameter'].sudo().get_param('report_suite_galaxus.use_delivery_reports') == 'True'">
					<t t-call="report_suite_galaxus.report_delivery_document" t-lang="o._get_report_lang()"/></t>
				<t t-else="">
					<t t-call="stock.report_delivery_document" t-lang="o._get_report_lang()"/></t>
			</xpath>
		</template>
		<!-- Generic Delivery Slip Document Template -->
		<template id="report_delivery_document">
			<t t-set="doc" t-value="o"/>
			<t t-set="company" t-value="o.company_id.sudo() or res_company"/>
			<!-- HEADER & FOOTER VIA EXTERNAL LAYOUT -->
			<t t-call="report_suite_galaxus.external_layout">
				<div class="page" style="font-size:7pt;">
					<!-- DOCUMENT TITLE -->
					<div style="font-size:16pt; padding-top: 8mm;">
						<span>
							<t t-translation="on">Delivery Note</t>
						</span>
						<span t-field="doc.name"/>
					</div>
					<!-- ADDRESS TABLE -->
					<table class="table table-borderless" style="width:100%; margin-top:0mm; margin-bottom:5mm; table-layout:fixed; font-size:7pt;">
						<tr>
							<!-- DOCUMENT INFO (LEFT, ROWSPAN 2) -->
							<td style="width:55.5%; vertical-align:top; padding-left:0mm;" rowspan="2">
								<table class="table table-borderless" style="width:100%; table-layout:fixed;">
									<!-- Delivery Number -->
									<tr t-if="doc.name">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">Delivery Number</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-field="doc.name"/>
											<br/>
										</td>
									</tr>
									<!-- Shipping Date -->
									<tr t-if="doc.scheduled_date or doc.date_done">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">Shipping Date</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-if="doc.state == 'done'" t-field="doc.date_done" t-options="{'widget':'date'}"/>
											<span t-else="" t-field="doc.scheduled_date" t-options="{'widget':'date'}"/>
											<br/>
										</td>
									</tr>
									<!-- Order / Origin -->
									<tr t-if="doc.origin">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">Order</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-field="doc.origin"/>
											<br/>
										</td>
									</tr>
									<!-- Customer Reference (from related SO if available) -->
									<t t-set="so" t-value="doc.sale_id or (doc.move_ids and doc.move_ids[0].sale_line_id and doc.move_ids[0].sale_line_id.order_id) or False"/>
									<tr t-if="so and so.client_order_ref">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">Customer Reference</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-field="so.client_order_ref"/>
											<br/>
										</td>
									</tr>
									<!-- Your Contact Person -->
									<t t-set="sp" t-value="(so and so.user_id) or doc.user_id or (doc.partner_id and doc.partner_id.user_id) or False"/>
									<tr t-if="sp">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">Your Contact Person</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-field="sp.name"/>
											<br/>
											<t t-if="sp.partner_id.email">
												<span t-field="sp.partner_id.email"/>
												<br/>
											</t>
											<t t-set="sp_phone" t-value="sp.partner_id.phone"/>
											<t t-if="sp_phone">
												<span t-esc="sp_phone"/>
												<br/>
											</t>
										</td>
									</tr>
									<!-- VAT No. / VAT ID -->
									<tr t-if="doc.partner_id.vat">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">VAT No. / VAT ID</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-field="doc.partner_id.vat"/>
											<br/>
										</td>
									</tr>
									<!-- Delivery Method -->
									<tr>
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">Delivery Method</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<t t-if="doc.carrier_id">
												<span t-field="doc.carrier_id.name"/>
												<br/>
											</t>
											<t t-else="">
												<t t-translation="on">Shipping</t>
												<br/>
											</t>
										</td>
									</tr>
								</table>
							</td>
							<!--  CUSTOMER ADDRESS (TOP CENTER)  -->
							<td style="width:24.5%; padding-left:0mm; padding-bottom:8mm; font-size: 8pt;">
								<t t-set="bill" t-value="doc.partner_id"/>
								<t t-set="company_name" t-value="bill.commercial_company_name or (bill.parent_id and bill.parent_id.name) or ''"/>
								<t t-if="company_name">
									<span t-esc="company_name"/>
									<br/>
								</t>
								<t t-if="bill.name and bill.name != company_name">
									<span t-esc="bill.name"/>
									<br/>
								</t>
								<t t-if="bill.street">
									<span t-field="bill.street"/>
									<br/>
								</t>
								<t t-if="bill.street2">
									<span t-field="bill.street2"/>
									<br/>
								</t>
								<t t-if="bill.zip or bill.city">
									<span t-if="bill.zip" t-field="bill.zip"/>
									<span t-if="bill.city">
										<t t-esc="bill.city"/>
									</span>
									<br/>
								</t>
								<t t-if="bill.country_id">
									<span t-field="bill.country_id.name"/>
									<br/>
								</t>
							</td>
							<!-- SPACER DIV -->
							<td style="width:20%; vertical-align:top; padding-left:0mm;"/>
						</tr>
						<tr>
							<!-- DELIVERY ADDRESS (BOTTOM MIDDLE) -->
							<td style="width:20%; vertical-align:top; padding-left:0mm; font-size: 8pt;">
								<div style="margin-top:-3mm;">
									<strong>
										<t t-translation="on">Delivery Address</t>
									</strong>
									<br/>
									<t t-set="ship" t-value="doc.partner_id or (doc.move_ids and doc.move_ids[0].partner_id) or False"/>
									<t t-if="ship and ship.name">
										<span t-field="ship.name"/>
										<br/>
									</t>
									<t t-if="ship and ship.street">
										<span t-field="ship.street"/>
										<br/>
									</t>
									<t t-if="ship and ship.street2">
										<span t-field="ship.street2"/>
										<br/>
									</t>
									<t t-if="ship and (ship.zip or ship.city)">
										<span t-if="ship.zip" t-field="ship.zip"/>
										<span t-if="ship.city">
											<t t-esc="ship.city"/>
										</span>
										<br/>
									</t>
									<t t-if="ship and ship.country_id">
										<span t-field="ship.country_id.name"/>
										<br/>
									</t>
									<t t-if="ship and ship.phone">
										<span t-field="ship.phone"/>
										<br/>
									</t>
								</div>
							</td>
							<td/>
						</tr>
					</table>
					<!-- ===== TABLES SECTION ===== -->
					<!-- When picking is NOT done: show ordered vs delivered -->
					<table t-if="doc.state != 'done'" class="table table-borderless" style="width:100%; font-size:7pt; margin-top: 5mm; table-layout:fixed;">
						<thead style="border-bottom:1px solid #ccc;">
							<tr>
								<th style="text-align:left; padding:1mm 4mm 1mm 0mm; width:65%;">
									<strong>
										<t t-translation="on">Product</t>
									</strong>
								</th>
								<th style="text-align:left; padding:1mm 1mm 1mm 0mm; width:15%;">
									<strong>
										<t t-translation="on">SKU</t>
									</strong>
								</th>
								<th style="text-align:right; padding:1mm 1mm 1mm 0mm; width:10%;">
									<strong>
										<t t-translation="on">Ordered</t>
									</strong>
								</th>
								<th style="text-align:right; padding:1mm 0mm 1mm 0mm; width:10%;">
									<strong>
										<t t-translation="on">Delivered</t>
									</strong>
								</th>
							</tr>
						</thead>
						<tbody>
							<t t-set="lines" t-value="doc.move_ids.filtered(lambda x: x.product_uom_qty)"/>
							<tr t-foreach="lines" t-as="move" style="border-bottom:1px solid #ccc;">
								<!-- Product -->
								<td style="text-align:left; padding:1mm 4mm 1mm 0mm;">
									<span t-field="move.product_id"/>
									<p t-if="move.description_picking and move.description_picking != move.product_id.name and move.description_picking != move.product_id.display_name" style="margin:2px 0 0 0;">
										<span t-field="move.description_picking"/>
									</p>
								</td>
								<!-- SKU -->
								<td style="text-align:left; padding:1mm 1mm 1mm 0mm;">
									<t t-if="move.product_id">
										<t t-esc="move.product_id.default_code or ''"/></t>
								</td>
								<!-- Ordered -->
								<td style="text-align:right; padding:1mm 1mm 1mm 0mm; white-space:nowrap;">
									<span t-out="move.product_uom_qty or 0.0" t-options="{'widget':'float','precision': 0}"/>
									<span t-translation="off"> </span>
									<span t-field="move.product_uom"/>
								</td>
								<!-- Delivered -->
								<td style="text-align:right; padding:1mm 0mm 1mm 0mm; white-space:nowrap;">
									<span t-out="move.quantity or 0.0" t-options="{'widget':'float','precision': 0}"/>
									<span t-translation="off"> </span>
									<span t-field="move.product_uom"/>
								</td>
							</tr>
						</tbody>
					</table>
					<!-- When picking is DONE: show delivered quantities -->
					<table t-if="doc.state == 'done'" class="table table-borderless" style="width:100%; font-size:7pt; margin-top: 5mm; table-layout:fixed;">
						<thead style="border-bottom:1px solid #ccc;">
							<tr>
								<th style="text-align:left; padding:1mm 4mm 1mm 0mm; width:80%;">
									<t t-translation="on">Product</t>
								</th>
								<th style="text-align:left; padding:1mm 1mm 1mm 0mm; width:10%;">
									<t t-translation="on">SKU</t>
								</th>
								<th style="text-align:right; padding:1mm 0mm 1mm 0mm; width:10%;">
									<t t-translation="on">Delivered</t>
								</th>
							</tr>
						</thead>
						<tbody>
							<t t-set="lines" t-value="doc.move_ids"/>
							<tr t-foreach="lines" t-as="move" t-if="(move.product_uom_qty or 0.0) != 0.0 or (move.quantity or 0.0) != 0.0" style="border-bottom:1px solid #ccc;">
								<!-- Product -->
								<td style="text-align:left; padding:1mm 4mm 1mm 0mm;">
									<span t-field="move.product_id"/>
									<p t-if="move.description_picking and move.description_picking != move.product_id.name and move.description_picking != move.product_id.display_name" style="margin:2px 0 0 0;">
										<span t-field="move.description_picking"/>
									</p>
								</td>
								<!-- SKU -->
								<td style="text-align:left; padding:1mm 1mm 1mm 0mm;">
									<t t-if="move.product_id">
										<t t-esc="move.product_id.default_code or ''"/></t>
								</td>
								<!-- Delivered  -->
								<td style="text-align:right; padding:1mm 0mm 1mm 0mm; white-space:nowrap;">
									<span t-out="move.quantity or 0.0" t-options="{'widget':'float','precision': 0}"/>
									<span t-translation="off"> </span>
									<span t-field="move.product_uom"/>
								</td>
							</tr>
						</tbody>
					</table>
					<!-- Backorders -->
					<t t-set="backorders" t-value="o.backorder_ids.filtered(lambda x: x.state not in ('done', 'cancel'))"/>
					<t t-if="backorders">
						<p style="margin:0 0 1mm 0; font-size:8pt;">
							<strong>
								<t t-translation="on">Remaining quantities not yet delivered</t>
							</strong>
						</p>
						<table class="table table-borderless" style="width:100%; font-size:7pt; margin-top: 5mm; table-layout:fixed;">
							<thead style="border-bottom:1px solid #ccc;">
								<tr>
									<th style="text-align:left; padding:1mm 4mm 1mm 0mm; width:80%;">
										<t t-translation="on">Product</t>
									</th>
									<th style="text-align:left; padding:1mm 1mm 1mm 0mm; width:10%;">
										<t t-translation="on">SKU</t>
									</th>
									<th style="text-align:right; padding:1mm 0mm 1mm 0mm; width:10%;">
										<t t-translation="on">Quantity</t>
									</th>
								</tr>
							</thead>
							<tbody>
								<tr t-foreach="backorders.mapped('move_ids').filtered(lambda x: x.product_uom_qty)" t-as="bo_line" style="border-bottom:1px solid #ccc;">
									<!-- Product  -->
									<td style="text-align:left; padding:1mm 4mm 1mm 0mm;">
										<span t-field="bo_line.product_id"/>
										<p t-if="bo_line.description_picking and bo_line.description_picking != bo_line.product_id.name and bo_line.description_picking != bo_line.product_id.display_name" style="margin:2px 0 0 0;">
											<span t-field="bo_line.description_picking"/>
										</p>
									</td>
									<!-- SKU-->
									<td style="text-align:left; padding:1mm 1mm 1mm 0mm;">
										<t t-if="bo_line.product_id">
											<t t-esc="bo_line.product_id.default_code or ''"/></t>
									</td>
									<!-- Quantity -->
									<td style="text-align:right; padding:1mm 0mm 1mm 0mm; white-space:nowrap;">
										<span t-out="bo_line.product_uom_qty or 0.0" t-options="{'widget':'float','precision': 0}"/>
										<span t-translation="off"> </span>
										<span t-field="bo_line.product_uom"/>
									</td>
								</tr>
							</tbody>
						</table>
					</t>
					<!-- INFORMATION BLOCK -->
					<table class="table table-borderless" style="table-layout: fixed; text-align: left; font-size:7pt; margin-top:10mm;">
						<!-- DAMAGE CHECK NOTE -->
						<tr>
							<td style="width: 15%; padding:1mm 1mm 1mm 0mm;">
								<t t-translation="on">Delivery</t>
							</td>
							<td style="width: 85%; padding:1mm 1mm 1mm 0mm;">
								<t t-translation="on">Please check the ordered products upon receipt for correctness, completeness, and any shipping damage. Any defects should be reported as soon as possible after receipt.</t>
							</td>
						</tr>
						<!-- TERMS AND CONDITIONS -->
						<tr>
							<td style="width: 15%; padding:1mm 1mm 1mm 0mm;">
								<t t-translation="on">General</t>
							</td>
							<td style="width: 85%; padding:1mm 1mm 1mm 0mm;">
								<t t-translation="on">Our General Terms and Conditions apply.</t>
							</td>
						</tr>
					</table>
					<!-- DELIVERED SERIALS MAP                                                 -->
					<!-- For each product line, collect serial/lot names from DONE moves       -->
					<!-- delivered to a customer (incl. dropship). Deduplicate & sort.         -->
					<t t-set="serials_map" t-value="{}"/>
					<t t-foreach="doc.move_ids" t-as="l">
						<t t-if="l.product_id and l.product_id.tracking in ('lot','serial') and l.state == 'done' and l.location_dest_id and l.location_dest_id.usage == 'customer'">
							<t t-set="lot_lines" t-value="l.move_line_ids.filtered(lambda ml: ml.lot_id or ml.lot_name)"/>
							<t t-set="lots_raw" t-value="[(ml.lot_id.name or ml.lot_name) for ml in lot_lines if (ml.lot_id or ml.lot_name)]"/>
							<t t-if="lots_raw">
								<t t-set="pid" t-value="l.product_id.id"/>
								<t t-set="prev" t-value="serials_map.get(pid, [])"/>
								<t t-set="merged" t-value="sorted(set(prev + lots_raw))"/>
								<t t-set="serials_map" t-value="dict(list(serials_map.items()) + [(pid, merged)])"/></t>
						</t>
					</t>
					<t t-set="has_serials" t-value="len(serials_map) &gt; 0"/>
					<!-- DELIVERED SERIAL NUMBERS (TABLE)                                      -->
					<!-- Header appears only once (placed in TBODY). Columns 25% / 75%.        -->
					<t t-if="has_serials">
						<table class="table table-borderless" style="width:100%; margin-top:6mm; font-size:7pt; border-collapse:collapse; table-layout:auto;">
							<colgroup>
								<col style="width:25%"/>
								<col style="width:75%"/>
							</colgroup>
							<tbody>
								<!-- Title row (single display) -->
								<tr style="border-bottom:1px solid #ccc;">
									<td colspan="2" style="text-align:left; padding:1mm 0 1mm 0;">
										<strong>
											<t t-translation="on">Delivered Serial Numbers</t>
										</strong>
									</td>
								</tr>
								<!-- Column headers (non-repeating) -->
								<tr>
									<td style="width:25%; text-align:left; padding:1mm 2mm 1mm 0mm;">
										<t t-translation="on">Product</t>
									</td>
									<td style="width:75%; text-align:left; padding:1mm 0mm 1mm 0mm;">
										<t t-translation="on">Serial Numbers</t>
									</td>
								</tr>
								<t t-set="seen" t-value="set()"/>
								<t t-foreach="doc.move_ids" t-as="l">
									<t t-set="pid" t-value="l.product_id and l.product_id.id"/>
									<t t-if="pid and serials_map.get(pid) and (pid not in seen)">
										<tr style="border-bottom:1px solid #ccc;">
											<td style="width:25%; padding:1mm 2mm 1mm 0mm; text-align:left; vertical-align:top;">
												<span t-esc="l.product_id.display_name"/>
											</td>
											<td style="width:75%; padding:1mm 0mm 1mm 0mm; text-align:left; vertical-align:top; white-space:normal; word-break:break-word;">
												<span t-esc="', '.join(serials_map.get(pid) or [])"/>
											</td>
										</tr>
										<t t-set="seen" t-value="seen.union({pid})"/></t>
								</t>
							</tbody>
						</table>
					</t>
				</div>
			</t>
		</template>
	</data>
</odoo>