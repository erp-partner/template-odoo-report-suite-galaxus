<?xml version="1.0" encoding="utf-8"?>
<odoo>
	<data>
		<!-- Inherit the standard invoice report to inject the template -->
		<template id="report_invoice_inherit_report_suite_galaxus" inherit_id="account.report_invoice">
			<xpath expr="//t[@t-call='account.report_invoice_document']" position="replace">
				<t t-if="env['ir.config_parameter'].sudo().get_param('report_suite_galaxus.use_invoice_reports') == 'True'">
					<t t-call="report_suite_galaxus.report_invoice_document" t-lang="lang"/></t>
				<t t-else="">
					<t t-call="account.report_invoice_document" t-lang="lang"/></t>
			</xpath>
		</template>

		<!-- Generic Invoice Document Template -->
		<template id="report_invoice_document">
			<t t-set="doc" t-value="o"/>
			<t t-set="company" t-value="o.company_id.sudo() or res_company"/>
			<t t-set="proforma" t-value="env.context.get('proforma', False)"/>
			<t t-call="report_suite_galaxus.external_layout">
				<div class="page" style="font-size:7pt;">
					<!-- DOCUMENT TITLE -->
					<div style="font-size:16pt; padding-top: 8mm;">
						<span t-if="proforma">
							<t t-translation="on">Proforma Invoice</t>
						</span>
						<span t-elif="doc.move_type == 'out_invoice' and doc.state == 'posted'">
							<t t-translation="on">Invoice</t>
						</span>
						<span t-elif="doc.move_type == 'out_invoice' and doc.state == 'draft'">
							<t t-translation="on">Draft Invoice</t>
						</span>
						<span t-elif="doc.move_type == 'out_invoice' and doc.state == 'cancel'">
							<t t-translation="on">Cancelled Invoice</t>
						</span>
						<span t-elif="doc.move_type == 'out_refund' and doc.state == 'posted'">
							<t t-translation="on">Credit Note</t>
						</span>
						<span t-elif="doc.move_type == 'out_refund' and doc.state == 'draft'">
							<t t-translation="on">Draft Credit Note</t>
						</span>
						<span t-elif="doc.move_type == 'out_refund' and doc.state == 'cancel'">
							<t t-translation="on">Cancelled Credit Note</t>
						</span>
						<span t-elif="doc.move_type == 'in_refund'">
							<t t-translation="on">Vendor Credit Note</t>
						</span>
						<span t-elif="doc.move_type == 'in_invoice'">
							<t t-translation="on">Vendor Bill</t>
						</span>
						<span t-field="doc.name"/>
					</div>
					<!-- ADDRESS TABLE -->
					<table class="table table-borderless" style="width:100%; margin-top:0mm; margin-bottom:5mm; table-layout:fixed; font-size:7pt;">
						<tr>
							<!-- DOCUMENT INFO (LEFT, ROWSPAN 2) -->
							<td style="width:55.5%; vertical-align:top; padding-left:0mm;" rowspan="2">
								<table class="table table-borderless" style="width:100%; table-layout:fixed;">
									<!-- Number -->
									<tr t-if="doc.name">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong t-if="proforma">
												<t t-translation="on">Proforma Number</t>
											</strong>
											<strong t-elif="doc.move_type == 'out_invoice' and doc.state == 'posted'">
												<t t-translation="on">Invoice Number</t>
											</strong>
											<strong t-elif="doc.move_type == 'out_invoice' and doc.state == 'draft'">
												<t t-translation="on">Draft Invoice</t>
											</strong>
											<strong t-elif="doc.move_type == 'out_invoice' and doc.state == 'cancel'">
												<t t-translation="on">Cancelled Invoice</t>
											</strong>
											<strong t-elif="doc.move_type == 'out_refund' and doc.state == 'posted'">
												<t t-translation="on">Credit Note</t>
											</strong>
											<strong t-elif="doc.move_type == 'out_refund' and doc.state == 'draft'">
												<t t-translation="on">Draft Credit Note</t>
											</strong>
											<strong t-elif="doc.move_type == 'out_refund' and doc.state == 'cancel'">
												<t t-translation="on">Cancelled Credit Note</t>
											</strong>
											<strong t-elif="doc.move_type == 'in_refund'">
												<t t-translation="on">Vendor Credit Note</t>
											</strong>
											<strong t-elif="doc.move_type == 'in_invoice'">
												<t t-translation="on">Vendor Bill</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-field="doc.name"/>
											<br/>
										</td>
									</tr>
									<!-- Date -->
									<tr t-if="doc.invoice_date">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong t-if="doc.move_type == 'out_invoice'">
												<t t-translation="on">Invoice Date</t>
											</strong>
											<strong t-elif="doc.move_type == 'out_refund'">
												<t t-translation="on">Credit Note Date</t>
											</strong>
											<strong t-elif="doc.move_type == 'out_receipt'">
												<t t-translation="on">Receipt Date</t>
											</strong>
											<strong t-else="">
												<t t-translation="on">Date</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-field="doc.invoice_date" t-options="{'widget':'date'}"/>
											<br/>
										</td>
									</tr>
									<!-- Due Date -->
									<tr t-if="doc.invoice_date_due and doc.move_type == 'out_invoice' and doc.state == 'posted'">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">Due Date</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-field="doc.invoice_date_due" t-options="{'widget':'date'}"/>
											<br/>
										</td>
									</tr>
									<!-- Order -->
									<tr t-if="doc.invoice_origin">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">Order</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-field="doc.invoice_origin"/>
											<br/>
										</td>
									</tr>
									<!-- Reference -->
									<tr t-if="doc.ref">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">Reference</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-field="doc.ref"/>
											<br/>
										</td>
									</tr>
									<!-- Your Contact Person -->
									<tr t-if="doc.invoice_user_id">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">Your Contact Person</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-field="doc.invoice_user_id.name"/>
											<br/>
											<t t-if="doc.invoice_user_id.partner_id.email">
												<span t-field="doc.invoice_user_id.partner_id.email"/>
												<br/>
											</t>
											<t t-set="sp_phone" t-value="doc.invoice_user_id.partner_id.phone"/>
											<t t-if="sp_phone">
												<span t-esc="sp_phone"/>
												<br/>
											</t>
										</td>
									</tr>
									<!-- VAT No. / VAT ID -->
									<tr t-if="doc.partner_id.vat">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">VAT No. / VAT ID</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-field="doc.partner_id.vat"/>
											<br/>
										</td>
									</tr>
									<!-- Delivery Method -->
									<tr>
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">Delivery Method</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<t t-if="doc._fields.get('carrier_id') and doc.carrier_id">
												<span t-field="doc.carrier_id.name"/>
												<br/>
											</t>
											<t t-else="">
												<t t-translation="on">Shipping</t>
												<br/>
											</t>
										</td>
									</tr>
									<!-- Currency -->
									<tr t-if="doc.currency_id">
										<td style="width:35%; vertical-align:top; padding:0mm;">
											<strong>
												<t t-translation="on">Currency</t>
											</strong>
										</td>
										<td style="width:65%; vertical-align:top; padding:0mm;">
											<span t-field="doc.currency_id.name"/>
											<br/>
										</td>
									</tr>
								</table>
							</td>
							<!-- INVOICE ADDRESS (TOP CENTER) -->
							<td style="width:24.5%; padding-left:0mm; padding-bottom:8mm; font-size: 8pt;">
								<t t-if="doc.partner_id.name">
									<span t-field="doc.partner_id.name"/>
									<br/>
								</t>
								<t t-if="doc.partner_id.street">
									<span t-field="doc.partner_id.street"/>
									<br/>
								</t>
								<t t-if="doc.partner_id.street2">
									<span t-field="doc.partner_id.street2"/>
									<br/>
								</t>
								<t t-if="doc.partner_id.zip or doc.partner_id.city">
									<span t-if="doc.partner_id.zip" t-field="doc.partner_id.zip"/>
									<span t-if="doc.partner_id.city">
										<t t-esc="doc.partner_id.city"/>
									</span>
									<br/>
								</t>
								<t t-if="doc.partner_id.country_id">
									<span t-field="doc.partner_id.country_id.name"/>
									<br/>
								</t>
							</td>
							<!-- SPACER DIV -->
							<td style="width:20%; vertical-align:top; padding-left:0mm;"/>
						</tr>
						<tr>
							<!-- DELIVERY ADDRESS (BOTTOM MIDDLE) -->
							<td style="width:20%; vertical-align:top; padding-left:0mm; font-size: 7pt;">
								<div t-if="doc.partner_shipping_id and doc.partner_shipping_id != doc.partner_id" style="margin-top:-3mm;">
									<strong>
										<t t-translation="on">Delivery Address</t>
									</strong>
									<br/>
									<t t-set="ship" t-value="doc.partner_shipping_id or doc.partner_id"/>
									<t t-if="ship.name">
										<span t-field="ship.name"/>
										<br/>
									</t>
									<t t-if="ship.street">
										<span t-field="ship.street"/>
										<br/>
									</t>
									<t t-if="ship.street2">
										<span t-field="ship.street2"/>
										<br/>
									</t>
									<t t-if="ship.zip or ship.city">
										<span t-if="ship.zip" t-field="ship.zip"/>
										<span t-if="ship.city">
											<t t-esc="ship.city"/>
										</span>
										<br/>
									</t>
									<t t-if="ship.country_id">
										<span t-field="ship.country_id.name"/>
										<br/>
									</t>
								</div>
							</td>
							<td/>
						</tr>
					</table>
					<!-- DELIVERY SUMMARY MAP -->
					<!-- For each invoice line, find DONE stock moves to customer,      -->
					<!--group qty by picking date_done, convert to line's UoM, format. -->
					<t t-set="deliveries_map" t-value="{}"/>
					<t t-foreach="o.invoice_line_ids" t-as="l">
						<t t-if="l.display_type == 'product' and l.product_id">
							<t t-set="moves" t-value="l.sale_line_ids.sudo().mapped('move_ids').filtered(          lambda m: m.state == 'done'                    and m.picking_id                    and m.location_dest_id                    and m.location_dest_id.usage == 'customer'                    and m.product_id == l.product_id        )"/>
							<t t-set="by_date" t-value="{}"/>
							<t t-foreach="moves" t-as="m">
								<t t-set="dtfull" t-value="m.picking_id.date_done or m.date"/>
								<t t-set="d" t-value="dtfull and dtfull.date() or None"/>
								<t t-set="q" t-value="(sum(m.move_line_ids.mapped('quantity')) or m.quantity_done or 0.0)"/>
								<t t-if="m.product_uom and l.product_uom_id and m.product_uom != l.product_uom_id">
								<t t-set="q" t-value="m.product_uom._compute_quantity(q, l.product_uom_id)"/></t>
								<t t-set="prev" t-value="by_date.get(d, 0.0)"/>
								<t t-set="by_date" t-value="dict(list(by_date.items()) + [(d, (prev or 0.0) + (q or 0.0))])"/></t>
							<t t-set="items_sorted" t-value="sorted(list(by_date.items()), key=lambda it: it[0] or o.invoice_date)"/>
							<t t-set="fmt_lines" t-value="[          ((d or o.invoice_date).strftime('%d.%m.%Y') + ': ' + ('%.0f' % (qty or 0.0)))          for d, qty in items_sorted        ]"/>
							<t t-set="deliveries_map" t-value="dict(list(deliveries_map.items()) + [(l.id, fmt_lines)])"/></t>
					</t>
					<!-- INVOICE LINES TABLE -->
					<t t-set="display_discount" t-value="any(l.discount for l in o.invoice_line_ids)"/>
					<t t-set="has_long_desc" t-value="any(line.name and line.name.count('\n') &gt; 30 for line in o.invoice_line_ids if line.name)"/>
					<table class="table table-borderless" style="width:100%; font-size:7pt; margin-top: 5mm; table-layout:fixed;">
						<thead style="border-bottom:1px solid #ccc;">
							<tr>
								<!-- 1) Description -->
								<th style="text-align:left; padding:1mm 1mm 1mm 0mm; width:30%;">
									<span>
										<t t-translation="on">Description</t>
									</span>
								</th>
								<!-- 2) SKU -->
								<th style="text-align:left; padding:1mm 1mm 1mm 0mm; width:12%;">
									<span>
										<t t-translation="on">SKU</t>
									</span>
								</th>
								<!-- 3) Delivery Date -->
								<th style="text-align:left; padding:1mm 1mm 1mm 0mm; width:8%;">
									<span>
										<t t-translation="on">Delivery</t>
									</span>
								</th>
								<!-- 4) Quantity (no UoM) -->
								<th style="text-align:right; padding:1mm 1mm 1mm 0mm; width:8%;">
									<span>
										<t t-translation="on">Quantity</t>
									</span>
								</th>
								<!-- 5) VAT % -->
								<th style="text-align:right; padding:1mm 1mm 1mm 0mm; width:6%;">
									<span>
										<t t-translation="on">VAT</t>
									</span>
								</th>
								<!-- 6) Unit Price excl. VAT -->
								<th style="text-align:right; padding:1mm 1mm 1mm 0mm; width:8%;">
									<span>
										<t t-translation="on">Price excl.</t>
									</span>
								</th>
								<!-- 7) Unit Price incl. VAT -->
								<th style="text-align:right; padding:1mm 1mm 1mm 0mm; width:8%;">
									<span>
										<t t-translation="on">Price incl.</t>
									</span>
								</th>
								<!-- 8) Amount excl. VAT -->
								<th style="text-align:right; padding:1mm 1mm 1mm 0mm; width:10%;">
									<span>
										<t t-translation="on">Amount excl.</t>
									</span>
								</th>
								<!-- 9) Amount incl. VAT -->
								<th style="text-align:right; padding:1mm 0mm 1mm 0mm; width:10%;">
									<span>
										<t t-translation="on">Amount incl.</t>
									</span>
								</th>
							</tr>
						</thead>
						<tbody>
							<t t-set="current_section" t-value="False"/>
							<t t-set="current_subtotal" t-value="0"/>
							<t t-set="current_subtotal_incl" t-value="0"/>
							<t t-set="current_total" t-value="0"/>
							<t t-set="lines" t-value="o.invoice_line_ids.sorted(key=lambda l: (-l.sequence, l.date, l.move_name, -l.id), reverse=True)"/>
							<t t-foreach="lines" t-as="line">
								<t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal"/>
								<t t-set="current_subtotal_incl" t-value="current_subtotal_incl + (line.price_total or 0.0)"/>
								<t t-set="current_total" t-value="current_total + line.price_total"/>
								<tr t-att-style="'border-bottom:1px solid %s;' % ('#000' if (line_last and not current_section) else '#ccc')">
									<t t-if="line.display_type == 'product'">
										<!-- 1) Description -->
										<td style="padding:1mm 2mm 1mm 0mm; text-align:left;">
											<span t-if="line.name" t-field="line.name" t-options="{'widget': 'text'}"/>
										</td>
										<!-- 2) SKU -->
										<td style="padding:1mm 1mm 1mm 0mm; text-align:left;">
											<t t-if="line.product_id">
												<t t-esc="line.product_id.default_code or ''"/></t>
										</td>
										<!-- 3) Delivery -->
										<td style="padding:1mm 1mm 1mm 0mm; text-align:left;">
											<t t-set="dl" t-value="deliveries_map.get(line.id)"/>
											<t t-if="dl">
												<t t-foreach="dl" t-as="dline">
													<div>
														<t t-esc="dline"/>
													</div>
												</t>
											</t>
										</td>
										<!-- 4) Quantity (0 decimals via % formatting) -->
										<td style="padding:1mm 1mm 1mm 0mm; text-align:right; white-space:nowrap;">
											<span t-out="line.quantity or 0.0" t-options="{'widget':'float', 'precision': 0}"/>
											<span t-if="line.product_uom_id" t-field="line.product_uom_id"/>
										</td>
										<!-- 5) VAT % (rounded to 1 decimal, show % sign) -->
										<t t-set="vat_rates_list"
										   t-value="[tax.amount
													 for tx in line.tax_ids
													 for tax in (tx.children_tax_ids or [tx])
													 if tax.amount_type == 'percent']"/>
										<td style="padding:1mm 1mm 1mm 0mm; text-align:right;">
											<t t-if="vat_rates_list">
												<t t-foreach="vat_rates_list" t-as="rate">
													<span t-out="rate" t-options="{'widget':'float','precision': 1}"/>
													<t t-translation="off">%</t>
													<t t-if="not rate_last">, </t>
												</t>
											</t>
											<t t-else="">-</t>
										</td>
										<!-- 6) Unit Price excl. VAT (no currency; dynamic decimals) -->
										<td style="padding:1mm 1mm 1mm 0mm; text-align:right;">
											<t t-if="line.quantity">
												<span t-out="(line.price_subtotal or 0.0) / line.quantity if line.quantity else 0.0" t-options="{'widget':'float', 'precision': (o.currency_id.decimal_places or 2)}"/>
											</t>
											<t t-else="">-</t>
										</td>
										<!-- 7) Unit Price incl. VAT (no currency; dynamic decimals) -->
										<td style="padding:1mm 1mm 1mm 0mm; text-align:right;">
											<t t-if="line.quantity">
												<span t-out="(line.price_total or 0.0) / line.quantity if line.quantity else 0.0" t-options="{'widget':'float', 'precision': (o.currency_id.decimal_places or 2)}"/>
											</t>
											<t t-else="">-</t>
										</td>
										<!-- 8) Amount excl. VAT (no currency; dynamic decimals) -->
										<td style="padding:1mm 1mm 1mm 0mm; text-align:right;">
											<span t-out="line.price_subtotal or 0.0" t-options="{'widget':'float', 'precision': (o.currency_id.decimal_places or 2)}"/>
										</td>
										<!-- 9) Amount incl. VAT (no currency; dynamic decimals) -->
										<td style="padding:1mm 0mm 1mm 0mm; text-align:right;">
											<span t-out="line.price_total or 0.0" t-options="{'widget':'float', 'precision': (o.currency_id.decimal_places or 2)}"/>
										</td>
									</t>
									<!-- SECTION LINE -->
									<t t-elif="line.display_type == 'line_section'">
										<td style="padding:1mm 2mm 1mm 0mm; text-align:left;">
											<strong>
												<span t-if="line.name" t-field="line.name" t-options="{'widget': 'text'}"/>
											</strong>
										</td>
										<!-- empty remainder -->
										<td colspan="8"/>
										<t t-set="current_section" t-value="line"/>
										<t t-set="current_subtotal" t-value="0"/>
										<t t-set="current_subtotal_incl" t-value="0"/></t>
									<!-- NOTE LINE -->
									<t t-elif="line.display_type == 'line_note'">
										<td style="padding:1mm 2mm 1mm 0mm; text-align:left;">
											<span t-if="line.name" t-field="line.name" t-options="{'widget': 'text'}"/>
										</td>
										<!-- empty remainder -->
										<td colspan="8"/>
									</t>
								</tr>
								<!-- SECTION SUBTOTAL ROW -->
								<t t-if="current_section and (line_last or lines[line_index+1].display_type == 'line_section')">
									<tr t-att-style="'border-bottom:1px solid %s;' % ('#000' if line_last else '#ccc')">
										<!-- col 1: label -->
										<td style="padding:1mm 2mm 1mm 0mm; text-align:left;">
											<strong>
												<t t-translation="on">Subtotal</t>
											</strong>
										</td>
										<!-- cols 2–7: spacer -->
										<td colspan="6"/>
										<!-- col 8: excl. VAT -->
										<td style="padding:1mm 1mm 1mm 0mm; text-align:right;">
											<span t-out="current_subtotal or 0.0" t-options="{'widget':'float', 'precision': (o.currency_id.decimal_places or 2)}"/>
										</td>
										<!-- col 9: incl. VAT -->
										<td style="padding:1mm 0mm 1mm 0mm; text-align:right;">
											<span t-out="current_subtotal_incl or 0.0" t-options="{'widget':'float', 'precision': (o.currency_id.decimal_places or 2)}"/>
										</td>
									</tr>
									<t t-set="current_section" t-value="False"/></t>
							</t>
						</tbody>
						<!-- SUMMARY ROWS  -->
						<t t-set="vat_pct" t-value="(doc.amount_tax / doc.amount_untaxed * 100.0) if doc.amount_untaxed else 0.0"/>
						<t t-set="dec" t-value="doc.currency_id.decimal_places or 2"/>
						<!-- Sum row: show excl. in col 8 AND incl. in col 9 -->
						<tr style="border-top:1px solid #ccc; page-break-inside: avoid;">
							<!-- col 1–2 -->
							<td/>
							<td/>
							<!-- col 3–7: label -->
							<td colspan="5" style="padding:1mm 1mm 1mm 0mm; text-align:left;">
								<t t-translation="on">Total Amount</t>
							</td>
							<!-- col 8: Amount excl. VAT (no currency) -->
							<td style="padding:1mm 1mm 1mm 0mm; text-align:right; white-space:nowrap;">
								<span t-out="doc.amount_untaxed or 0.0" t-options="{'widget':'float', 'precision': dec}"/>
							</td>
							<!-- col 9: Amount incl. VAT (no currency) -->
							<td style="padding:1mm 0mm 1mm 0mm; text-align:right; white-space:nowrap;">
								<span t-out="doc.amount_total or 0.0" t-options="{'widget':'float', 'precision': dec}"/>
							</td>
						</tr>
						<!-- VAT row -->
						<!-- VAT HEADER LINE -->
						<tr style="page-break-inside: avoid;">
							<td/>
							<td/>
							<!-- col 3–9: header text across the summary block -->
							<td colspan="7" style="padding:1mm 1mm 0.5mm 0mm; border-bottom:1px solid #000; text-align:left;">
								<t t-translation="on">Total amount contains following VAT</t>
								<t t-translation="off">:</t>
							</td>
						</tr>
						<!-- VAT DETAIL LINE -->
						<tr style="page-break-inside: avoid;">
							<td/>
							<td/>
							<!-- col 3: VAT label -->
							<td colspan="2" style="padding:0.5mm 1mm 4mm 0mm; border-bottom:1px solid #000; text-align:left;">
								<t t-translation="on">VAT</t>
								<span t-out="vat_pct or 0.0" t-options="{'widget':'float','precision': 1}"/>
								<t t-translation="off">%</t>
							</td>
							<!-- spacer across cols 4–8 -->
							<td colspan="4" style="border-bottom:1px solid #000;"/>
							<!-- col 9: total VAT amount  -->
							<td style="padding:0.5mm 0mm 4mm 0mm; border-bottom:1px solid #000; text-align:right; white-space:nowrap;">
								<span t-out="doc.amount_tax or 0.0" t-options="{'widget':'float', 'precision': dec}"/>
							</td>
						</tr>
						<!-- Total row (incl. VAT stays in last column; col 8 left empty) -->
						<tr style="page-break-inside: avoid;">
							<td/>
							<td/>
							<td colspan="5" style="padding:1mm 1mm 1mm 0mm; border-bottom:1px solid #ccc; text-align:left;">
								<span>
									<t t-translation="on">Total of all deliveries and services</t>
									<t t-translation="off"/>
									<t t-esc="(doc.currency_id and doc.currency_id.name) or ''" t-translation="off"/>
								</span>
							</td>
							<!-- col 8 spacer  -->
							<td style="border-bottom:1px solid #ccc;"/>
							<!-- col 9: Total incl. VAT -->
							<td style="padding:1mm 0mm 1mm 0mm; border-bottom:1px solid #ccc; text-align:right; white-space:nowrap;">
								<span t-out="doc.amount_total or 0.0" t-options="{'widget':'float', 'precision': dec}"/>
							</td>
						</tr>
						<!-- PAYMENTS SUMMARY  -->
						<t t-set="print_with_payments" t-value="env.context.get('print_with_payments', True)"/>
						<t t-if="not proforma and print_with_payments and doc.state != 'draft'">
							<t t-set="widget" t-value="doc.with_company(doc.company_id).sudo().invoice_payments_widget or {}"/>
							<t t-set="payments_vals" t-value="widget.get('content', [])"/>
							<t t-foreach="payments_vals" t-as="payment_vals">
								<tr style="page-break-inside: avoid;">
									<td/>
									<td/>
									<td colspan="5" style="padding:1mm 1mm 1mm 0mm; border-bottom:1px solid #ccc; text-align:left;">
										<i class="oe_form_field oe_payment_label">
											<t t-if="payment_vals.get('is_refund')">
												<t t-translation="on">Reversed on </t>
											</t>
											<t t-else="">
												<t t-translation="on">Paid on </t>
											</t>
											<t t-out="payment_vals.get('date')" t-options="{'widget':'date'}"/>
										</i>
									</td>
									<!-- col 8 spacer -->
									<td style="border-bottom:1px solid #ccc;"/>
									<!-- col 9: payment amount (no currency) -->
									<td style="padding:1mm 0mm 1mm 0mm; border-bottom:1px solid #ccc; text-align:right; white-space:nowrap;">
										<span t-out="payment_vals.get('amount') or 0.0" t-options="{'widget':'float', 'precision': dec}"/>
									</td>
								</tr>
							</t>
							<tr style="page-break-inside: avoid;">
								<td/>
								<td/>
								<td colspan="5" style="padding:1mm 1mm 1mm 0mm; border-bottom:1px solid #000; text-align:left;">
									<t t-translation="on">Amount Due</t>
								</td>
								<!-- col 8 spacer -->
								<td style="border-bottom:1px solid #000;"/>
								<!-- col 9: residual (no currency) -->
								<td style="padding:1mm 0mm 1mm 0mm; border-bottom:1px solid #000; text-align:right; white-space:nowrap;">
									<span t-out="doc.amount_residual or 0.0" t-options="{'widget':'float', 'precision': dec}"/>
								</td>
							</tr>
						</t>
					</table>
					<!-- INFORMATION BLOCK -->
					<div style="font-size:7pt; margin-top:10mm;">
						<table class="table table-borderless" style="table-layout: fixed; text-align: left;">
							<!-- PAYMENT TERMS -->
							<tr t-if="o.invoice_payment_term_id">
								<td style="width:15%; padding:1mm 1mm 1mm 0mm;">
									<t t-translation="on">Payment Terms</t>
								</td>
								<td style="width:85%; padding:1mm 1mm 1mm 0mm;">
									<t t-set="payment_term_details" t-value="o.payment_term_details"/>
									<t t-set="dec" t-value="o.currency_id.decimal_places or 2"/>
									<!-- Payment term NAME -->
									<div t-if="o.invoice_payment_term_id">
										<span t-field="o.invoice_payment_term_id.name"/>
									</div>
									<!-- Details (same gating as original) -->
									<t t-if="o.invoice_payment_term_id.display_on_invoice and payment_term_details and o.show_payment_term_details">
										<!-- Early payment discount (no currency symbol) -->
										<div t-if="o._is_eligible_for_early_payment_discount(o.currency_id, o.invoice_date)" style="margin-top:1mm;">
											<span t-out="o.invoice_payment_term_id._get_amount_due_after_discount(o.amount_total, o.amount_tax) or 0.0" t-options="{'widget':'float', 'precision': dec}"/>
											<t t-translation="on"> due if paid before </t>
											<span t-out="o.invoice_payment_term_id._get_last_discount_date_formatted(o.invoice_date)"/>
										</div>
										<!-- Installments (only if more than one) -->
										<div t-if="len(payment_term_details) &gt; 1" style="margin-top:1mm;">
											<t t-foreach="payment_term_details" t-as="term">
												<div>
													<span t-esc="term_index + 1"/> -
													<t t-translation="on">Installment of</t>
													<span t-out="term.get('amount') or 0.0" t-options="{'widget':'float', 'precision': dec}"/>
													<t t-translation="on"> due on </t>
													<t t-out="term.get('date')"/>
												</div>
											</t>
										</div>
									</t>
								</td>
							</tr>
							<!-- DAMAGE CHECK NOTE -->
							<tr>
								<td style="width: 15%; padding:1mm 1mm 1mm 0mm;">
									<t t-translation="on">Delivery</t>
								</td>
								<td style="width: 85%; padding:1mm 1mm 1mm 0mm;">
								<t t-translation="on">Please check the ordered products upon receipt for correctness, completeness, and any shipping damage. Any defects should be reported as soon as possible after receipt.</t>
								</td>
							</tr>
							<!-- TERMS AND CONDITIONS -->
							<tr>
								<td style="width: 15%; padding:1mm 1mm 1mm 0mm;">
									<t t-translation="on">General</t>
								</td>
								<td style="width: 85%; padding:1mm 1mm 1mm 0mm;">
									<t t-translation="on">Our General Terms and Conditions apply.</t>
								</td>
							</tr>
							<!-- WARRANTY -->
							<tr>
								<td style="width: 15%; padding:1mm 1mm 1mm 0mm;">
									<t t-translation="on">Warranty</t>
								</td>
								<td style="width: 85%; padding:1mm 1mm 1mm 0mm;">
									<t t-translation="on">This document serves as your warranty certificate. For warranty claims, please contact our support team.</t>
								</td>
							</tr>
							<!-- FISCAL POSITION NOTE -->
							<tr t-if="not is_html_empty(o.fiscal_position_id.note)">
								<td colspan="2" style="width: 15%; padding:3mm 1mm 1mm 0mm;">
									<span t-field="o.fiscal_position_id.note"/>
								</td>
							</tr>
							<!-- LEGAL TAX NOTES -->
							<tr t-if="not is_html_empty(o.taxes_legal_notes)">
								<td colspan="2" style="width: 15%; padding:1mm 1mm 1mm 0mm;">
									<span t-field="o.taxes_legal_notes"/>
								</td>
							</tr>
						</table>
						<!-- PAYMENT REFERENCE IF NO QR PAYMENT SLIP -->
						<t t-if="not o.l10n_ch_is_qr_valid">
							<div style="page-break-after: always"/>
							<br/>
							<table t-if="o.move_type in ('out_invoice', 'in_refund')" class="table table-borderless" style="margin:3mm 0 3mm 0; table-layout: fixed; font-size: 7pt; text-align: left;">
								<colgroup>
									<col style="width:15%;"/>
									<col style="width:85%;"/>
								</colgroup>
								<!-- make bank available for all rows -->
								<t t-set="bank" t-value="o.partner_bank_id"/>
								<!-- Header -->
								<tr>
									<td colspan="2" style="padding:0 0 2mm 0;">
										<span style="font-size:14pt; font-weight:bold;">
											<t t-translation="on">Bank payment</t>
										</span>
									</td>
								</tr>
								<!-- Short instructions -->
								<tr>
									<td style="padding:1mm 1mm 1mm 0mm;">
										<t t-translation="on">Instructions</t>
									</td>
									<td style="padding:1mm 1mm 1mm 0mm;">
										<t t-translation="on">
				You can use this information to pay via online banking or at the bank counter. Don’t forget to include the reference.
			  </t>
									</td>
								</tr>
								<!-- Beneficiary -->
								<tr>
									<td style="padding:1mm 1mm 1mm 0mm;">
										<t t-translation="on">Beneficiary</t>
									</td>
									<td style="padding:1mm 1mm 1mm 0mm;">
										<div>
											<t t-esc="o.company_id.name or ''"/>
											<t t-if="o.company_id.street">,


												<t t-esc="o.company_id.street"/></t>
											<t t-if="o.company_id.street2">,


												<t t-esc="o.company_id.street2"/></t>
											<t t-if="o.company_id.zip or o.company_id.city or o.company_id.country_id">,


												<t t-if="o.company_id.country_id">
													<t t-esc="o.company_id.country_id.code or ''"/>-</t>
												<t t-if="o.company_id.zip">
													<t t-esc="o.company_id.zip"/></t>
												<t t-if="o.company_id.city">
													<t t-esc="o.company_id.city"/></t>
											</t>
										</div>
									</td>
								</tr>
								<!-- Financial institution -->
								<tr>
									<td style="padding:1mm 1mm 1mm 0mm;">
										<t t-translation="on">Financial institution</t>
									</td>
									<td style="padding:1mm 1mm 1mm 0mm;">
										<t t-if="bank and bank.bank_id and bank.bank_id.name">
											<t t-esc="bank.bank_id.name"/></t>
										<t t-else="">-</t>
									</td>
								</tr>
								<!-- IBAN -->
								<tr>
									<td style="padding:1mm 1mm 1mm 0mm;">IBAN</td>
									<td style="padding:1mm 1mm 1mm 0mm;">
										<t t-if="bank and bank.acc_number">
											<t t-esc="bank.acc_number"/></t>
										<t t-else="">-</t>
									</td>
								</tr>
								<!-- BIC -->
								<tr>
									<td style="padding:1mm 1mm 1mm 0mm;">BIC</td>
									<td style="padding:1mm 1mm 1mm 0mm;">
										<t t-if="bank and bank.bank_id and bank.bank_id.bic">
											<t t-esc="bank.bank_id.bic"/></t>
										<t t-else="">-</t>
									</td>
								</tr>
								<!-- Payment reference (invoice name) -->
								<tr>
									<td style="padding:1mm 1mm 1mm 0mm;">
										<t t-translation="on">Payment reference</t>
									</td>
									<td style="padding:1mm 1mm 1mm 0mm;">
										<t t-esc="o.name or ''"/>
									</td>
								</tr>
								<!-- Amount due -->
								<tr>
									<td style="padding:1mm 1mm 1mm 0mm;">
										<t t-translation="on">Amount due</t>
									</td>
									<td style="padding:1mm 1mm 1mm 0mm;">
										<t t-set="dec" t-value="o.currency_id.decimal_places or 2"/>
										<span t-out="o.amount_residual or 0.0" t-options="{'widget':'float', 'precision': dec}"/>
										<t t-translation="off"/>
										<t t-esc="(o.currency_id and o.currency_id.name) or ''"/>
									</td>
								</tr>
							</table>
						</t>
						<!-- QR CODE, INVISIBLE FOR NOW -->
						<t t-set="show_qr" t-value="o.display_qr_code and o.amount_residual &gt; 0 and not o.l10n_ch_is_qr_valid"/>
						<div t-if="show_qr" style="page-break-inside:avoid; break-inside:avoid; margin:3 0 3mm 0; font-size:7pt; display:none;">
							<t t-set="qr_code_url" t-value="o._generate_qr_code(silent_errors=True)"/>
							<t t-if="qr_code_url">
								<div style="display:inline-block; vertical-align:top; margin-right:6mm;">
									<img t-att-src="qr_code_url" style="height:40mm; width:40mm;"/>
								</div>
								<div style="display:inline-block; vertical-align:top; color:#666; font-style:italic;">
									<p style="margin:0;">
										<t t-translation="on">Scan this QR Code with</t>
										<br/>
										<t t-translation="on">your banking application</t>
									</p>
								</div>
							</t>
						</div>
					</div>
					<!-- DELIVERED SERIALS MAP                                                 -->
					<!-- For each product line, collect serial/lot names from DONE moves       -->
					<!-- delivered to a customer (incl. dropship). Deduplicate & sort.         -->
					<t t-set="serials_map" t-value="{}"/>
					<t t-foreach="o.invoice_line_ids" t-as="l">
						<t t-if="l.display_type == 'product' and l.product_id and l.product_id.tracking in ('lot','serial')">
							<t t-set="moves" t-value="l.sale_line_ids.sudo().mapped('move_ids').filtered(          lambda m: m.state == 'done'                    and m.picking_id                    and m.location_dest_id                    and m.location_dest_id.usage == 'customer'                    and m.product_id == l.product_id        )"/>
							<t t-set="lot_lines" t-value="moves.mapped('move_line_ids').filtered(lambda ml: ml.lot_id or ml.lot_name)"/>
							<t t-set="lots_raw" t-value="[(ml.lot_id.name or ml.lot_name) for ml in lot_lines if (ml.lot_id or ml.lot_name)]"/>
							<t t-if="lots_raw">
								<t t-set="pid" t-value="l.product_id.id"/>
								<t t-set="prev" t-value="serials_map.get(pid, [])"/>
								<t t-set="merged" t-value="sorted(set(prev + lots_raw))"/>
								<t t-set="serials_map" t-value="dict(list(serials_map.items()) + [(pid, merged)])"/></t>
						</t>
					</t>
					<t t-set="has_serials" t-value="len(serials_map) &gt; 0"/>
					<!-- DELIVERED SERIAL NUMBERS (TABLE)                                      -->
					<!-- Header appears only once (placed in TBODY). Columns 25% / 75%.        -->
					<t t-if="doc.move_type == 'out_invoice' and has_serials">
						<table class="table table-borderless" style="width:100%; margin-top:6mm; font-size:7pt; border-collapse:collapse; table-layout:auto;">
							<colgroup>
								<col style="width:25%"/>
								<col style="width:75%"/>
							</colgroup>
							<tbody>
								<!-- Title row (single display) -->
								<tr style="border-bottom:1px solid #ccc;">
									<td colspan="2" style="text-align:left; padding:1mm 0 1mm 0;">
										<strong>
											<t t-translation="on">Delivered Serial Numbers</t>
										</strong>
									</td>
								</tr>
								<!-- Column headers (non-repeating) -->
								<tr>
									<td style="width:25%; text-align:left; padding:1mm 2mm 1mm 0mm;">
										<t t-translation="on">Product</t>
									</td>
									<td style="width:75%; text-align:left; padding:1mm 0mm 1mm 0mm;">
										<t t-translation="on">Serial Numbers</t>
									</td>
								</tr>
								<t t-set="seen" t-value="set()"/>
								<t t-foreach="o.invoice_line_ids" t-as="l">
									<t t-set="pid" t-value="l.product_id and l.product_id.id"/>
									<t t-if="l.display_type == 'product' and pid and serials_map.get(pid) and (pid not in seen)">
										<tr style="border-bottom:1px solid #ccc;">
											<td style="width:25%; padding:1mm 2mm 1mm 0mm; text-align:left; vertical-align:top;">
												<span t-esc="l.product_id.display_name"/>
											</td>
											<td style="width:75%; padding:1mm 0mm 1mm 0mm; text-align:left; vertical-align:top; white-space:normal; word-break:break-word;">
												<span t-esc="', '.join(serials_map.get(pid) or [])"/>
											</td>
										</tr>
										<t t-set="seen" t-value="seen.union({pid})"/></t>
								</t>
							</tbody>
						</table>
					</t>
				</div>
				<t t-if="o.l10n_ch_is_qr_valid">
					<div style="page-break-after: always"/>
					<br/>
					<!-- PAYMENT REFERENCE ON QR PAGE FOR SWISS INVOICE -->
					<table t-if="o.move_type in ('out_invoice', 'in_refund')" class="table table-borderless" style="margin:3mm 0 3mm 0; table-layout: fixed; font-size: 7pt; text-align: left;">
						<colgroup>
							<col style="width:15%;"/>
							<col style="width:85%;"/>
						</colgroup>
						<!-- make bank available for all rows -->
						<t t-set="bank" t-value="o.partner_bank_id"/>
						<!-- Header -->
						<tr>
							<td colspan="2" style="padding:0 0 2mm 0;">
								<span style="font-size:14pt; font-weight:bold;">
									<t t-translation="on">Bank payment</t>
								</span>
							</td>
						</tr>
						<!-- Short instructions -->
						<tr>
							<td style="padding:1mm 1mm 1mm 0mm;">
								<t t-translation="on">Instructions</t>
							</td>
							<td style="padding:1mm 1mm 1mm 0mm;">
								<t t-translation="on">
				You can use this information to pay via online banking or at the bank counter. Don’t forget to include the reference.
			  </t>
							</td>
						</tr>
						<!-- Beneficiary -->
						<tr>
							<td style="padding:1mm 1mm 1mm 0mm;">
								<t t-translation="on">Beneficiary</t>
							</td>
							<td style="padding:1mm 1mm 1mm 0mm;">
								<div>
									<t t-esc="o.company_id.name or ''"/>
									<t t-if="o.company_id.street">,


										<t t-esc="o.company_id.street"/></t>
									<t t-if="o.company_id.street2">,


										<t t-esc="o.company_id.street2"/></t>
									<t t-if="o.company_id.zip or o.company_id.city or o.company_id.country_id">,


										<t t-if="o.company_id.country_id">
											<t t-esc="o.company_id.country_id.code or ''"/>-</t>
										<t t-if="o.company_id.zip">
											<t t-esc="o.company_id.zip"/></t>
										<t t-if="o.company_id.city">
											<t t-esc="o.company_id.city"/></t>
									</t>
								</div>
							</td>
						</tr>
						<!-- Financial institution -->
						<tr>
							<td style="padding:1mm 1mm 1mm 0mm;">
								<t t-translation="on">Financial institution</t>
							</td>
							<td style="padding:1mm 1mm 1mm 0mm;">
								<t t-if="bank and bank.bank_id and bank.bank_id.name">
									<t t-esc="bank.bank_id.name"/></t>
								<t t-else="">-</t>
							</td>
						</tr>
						<!-- IBAN -->
						<tr>
							<td style="padding:1mm 1mm 1mm 0mm;">IBAN</td>
							<td style="padding:1mm 1mm 1mm 0mm;">
								<t t-if="bank and bank.acc_number">
									<t t-esc="bank.acc_number"/></t>
								<t t-else="">-</t>
							</td>
						</tr>
						<!-- BIC -->
						<tr>
							<td style="padding:1mm 1mm 1mm 0mm;">BIC</td>
							<td style="padding:1mm 1mm 1mm 0mm;">
								<t t-if="bank and bank.bank_id and bank.bank_id.bic">
									<t t-esc="bank.bank_id.bic"/></t>
								<t t-else="">-</t>
							</td>
						</tr>
						<!-- Payment reference (invoice name) -->
						<tr>
							<td style="padding:1mm 1mm 1mm 0mm;">
								<t t-translation="on">Payment reference</t>
							</td>
							<td style="padding:1mm 1mm 1mm 0mm;">
								<t t-esc="o.name or ''"/>
							</td>
						</tr>
						<!-- Amount due -->
						<tr>
							<td style="padding:1mm 1mm 1mm 0mm;">
								<t t-translation="on">Amount due</t>
							</td>
							<td style="padding:1mm 1mm 1mm 0mm;">
								<t t-set="dec" t-value="o.currency_id.decimal_places or 2"/>
								<span t-out="o.amount_residual or 0.0" t-options="{'widget':'float', 'precision': dec}"/>
								<t t-translation="off"/>
								<t t-esc="(o.currency_id and o.currency_id.name) or ''"/>
							</td>
						</tr>
					</table>
				</t>
			</t>
		</template>
	</data>
</odoo>